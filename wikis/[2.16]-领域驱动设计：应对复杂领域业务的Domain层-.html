<!DOCTYPE html>
<html lang="cn" style="">
<head>
	<title>[2.16]-领域驱动设计：应对复杂领域业务的Domain层- | PhalApi - PHP轻量级后台接口开发框架</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="icon" href="http://webtools.qiniudn.com/dog_catch.png" type="image/x-icon" />
	<meta name="description" content="PhalApi是一个PHP轻量级后台接口开发框架。我们致力于将PhalApi维护成像恒星一样：不断更新，保持生气；为接口负责，为开源负责！让后台接口开发更简单！">
	<meta name="keywords" content="PhalApi,phalapi,phalapi接口开发,后台接口开发框架,后台接口开发,接口开发,接口框架,PHP后台接口开发,PHP接口开发,PHP接口框架,PHP后台接口框架,phalapi官网,PHP接口框架,phalapi文档,phalapi wiki,PhalApi文档,phalapi在线文档,phalapi官方文档">
	<meta name="author" content="dogstar">

	<link rel="stylesheet" type="text/css" href="./../css/screen.css?20150211" />
</head>

<body>

<!-- 最顶部的语言(S) -->
<div class="grid-wrapper navbar desktop-only">
	<div class="grid">
		<div class="grid__cell">
			<ul id="language-switchers" class="navbar__links navbar--left">
				<li class="menu-item"><a title="PhalApi官方网站中文版" href="./" class="menu-item__link">中文版</a></li>
				<li class="menu-item"><a title="English version of PhalApi website" href="#" class="menu-item__link">English</a></li>
			</ul>
			<ul id="util-menu" class="navbar__links navbar--right navbar--vertical-separator">
				<li class="menu-item"><a href="mailto:fuemoshi@gmail.com" class="menu-item__link contact-us-spec">保护大象，拒绝象牙！</a></li>
			</ul>
		</div>
	</div>
</div>
<!-- 最顶部的语言(E) -->

<!-- 顶部导航菜单(S) -->
<div class="grid-wrapper desktop-only">
	<div class="grid">
		<div class="grid__cell">
			<div class="header__header-wrapper">
				<a title="PhalApi" href="http://www.phalapi.net" class="header__logo"><img src="http://webtools.qiniudn.com/master-LOGO-20150410_33.jpg" id="tw-logo" alt="PhalApi"></a>
				<ul id="main-menu" class="header__menu">
					<li class="menu-item"><a href="/download.html" class="menu-item__link insights-spec" target="_blank">下载</a></li>
					<li class="menu-item"><a href="/wikis/" class="menu-item__link events-spec" target="_blank">文档</a></li>
    				<li class="menu-item"><a href="/docs/" class="menu-item__link events-spec" target="_blank">类参考手册</a></li>
					<li class="menu-item"><a href="http://phalapi.oschina.mopaas.com/Public/demo/" class="menu-item__link products-spec" target="_blank">在线体验</a></li>
					<li class="menu-item"><a href="/about.html" class="menu-item__link about-us-spec" target="_blank">关于我们</a></li>
				</ul>
			</div>
		</div>
	</div>
</div>
<!-- 顶部导航菜单(E) -->

    <div class="grid-wrapper">
        <div class="grid">
            <div class="grid__cell">
                <h4><a href="#">上一章</a>   <a href="/wikis/">文档首页</a>   <a href="#">下一章</a></h4>
<hr />
<p><em>温馨提示：此篇章需要比较长的时间才能最终定稿，因为我还要寻找最合适的方式和语言来表述。</em></p>
<h2>2.16.1 领域驱动设计</h2>
<p>很多框架关心性能，而不关心人文；很多项目关心技术，而不关注业务。  </p>
<p>就这造成了复杂的领域业务在项目中得不到很好地体现和描述，也没有统一的规则，更没有释意的接口。最终导致了在“纯面向对象”框架里面凌乱的代码编写，为后期的维护扩展、升级优化带来很大的阻碍。这就变成了，框架只关注性能，项目只关心技术，而项目却可怜地失去了演进的权利，慢慢地步履维艰，最终牵一发而动全身。  </p>
<p><strong>很多人都不知道该如何真正应对和处理领域的业务</strong> ，尽管领域业务和单元测试都是如此重要并被广泛推崇。正如同表面上我们都知道单元测试却没有具体真实地接触过，并且一旦到真正需要编写一行单元测试的代码时就傻眼了。  </p>
<p>这里不是发明一些新技术，也不是提供一些新的模式，而是继续将前人、大神和顶级大师关于领域驱动设计这方面的思想结合真实后台接口开发进行分享，进而推广之。</p>
<h2>2.16.2 讲述故事</h2>
<p>很多人，都喜欢听故事。像我以前中学的时候，就很喜欢看《故事会》。  </p>
<p>如果，我们能让代码也像小说一样，在讲述某个故事时，将会更加吸引“读者”（也就是其他开发同学），从而易于理解和维护。   </p>
<p>最近，我在做一个项目时，再一次发现了这种讲述故事的威力。  </p>
<h3>(1)一个第三方登录的写法</h3>
<p>我们先以F项目来命名这个项目，在F项目中，我们跟其他App一样，需要接入第三方登录，其中包括：微信登录、微博登录和QQ登录、邮箱登录等。  </p>
<p>以下，则是我根据 <strong>讲述故事</strong>  的方式，为微信登录编写的代码：</p>
<pre><code>&lt;?php

class Api_User_Login extends PhalApi_Api {

    public function getRules() {
        return array(
            'weixin' =&gt; array(
                'openId' =&gt; array('name' =&gt; 'wx_openid', 'require' =&gt; true, 'min' =&gt; 1, 'max' =&gt; 28),
                'token' =&gt; array('name' =&gt; 'wx_token', 'require' =&gt; true, 'min' =&gt; 1, 'max' =&gt; 150),
                'expiresIn' =&gt; array('name' =&gt; 'wx_expires_in', 'require' =&gt; true, 'min' =&gt; 1),
                'nickname' =&gt; array('name' =&gt; 'name', 'default' =&gt; '',),
                'avatar' =&gt; array('name' =&gt; 'avatar', 'default' =&gt; '',),
            ),
        );
    }

    public function weixin()
    {
        $rs = array('code' =&gt; 0, 'info' =&gt; array(), 'msg' =&gt; '');

        $domain = new Domain_User_Login_Weixin();
        $isFirstBind = $domain-&gt;isFirstBind($this-&gt;openId);

        $userId = 0;
        if ($isFirstBind) {
            $userId = Domain_User_Generator::createUserForWeixin(
                   $this-&gt;openId, $this-&gt;nickname, $this-&gt;avatar);

            $domain-&gt;bindUser($userId, $this-&gt;openId, $this-&gt;token, $this-&gt;expiresIn);
        } else {
            $userId = $domain-&gt;getUserIdByWxOpenId($this-&gt;openId);
        }

        $token = Domain_User_Session::generate($userId, $this-&gt;client);

        $rs['info']['user_id'] = $userId;
        $rs['info']['token'] = $token;
        $rs['info']['is_new'] = $isFirstBind ? 1 : 0;

        return $rs;
    }
}</code></pre>
<blockquote>
<p>温馨提示：<br />
以下代码为我正在参与开发的一个项目的源代码，已征得项目负责人同意。同时出于对项目的尊重，已省去部分代码。  </p>
</blockquote>
<h3>(2)登录场景的故事</h3>
<p>细细品读上面的代码，其实就是在描述登录场景的故事：<br />
当用户进行微信登录时，先查看用户是否首次登录；如果是，则为用户自动生成了一个帐号并绑定，如果不是，则获取已绑定的用户ID；最后，生成一个登录态的token。  </p>
<p>当然，这里为了突出故事的主线，已去除了很多异常情况的处理。</p>
<h3>(3)有趣的开发体验</h3>
<p>更为有趣的是，此次参与F项目开发的还有另外一位同学。<br />
这位同学拥有多年资深的iOS开发经验，但对PHP开发还是首次接触，但他在参考微信登录的写法后，很快就交付了微博和QQ登录这两个接口服务。  </p>
<p>但令我为之惊讶和兴奋的不是他的速度，而是他所编写的代码是如此的优雅美丽，犹如出自资深PHP开发人员之手。  </p>
<p>这让我再一次相信，使用 <strong>讲述故事</strong> 的方式来开发接口，不仅能让代码更易于传送业务逻辑，也能为更多的同学乃至新手接受并快速上手。</p>
<h3>(4)与TDD的结合</h3>
<p><strong>讲述故事</strong> 有一个很明显的特点就是，全部的操作都是处于同一抽象级别的，即都是释意接口下的领域业务规则和操作。  </p>
<p>但对于如何引出这个业务场景，很多人用传统的方式都是写一个接口，然后在浏览器调试。  </p>
<p>其实，这并不是最好的开发体验。因为，使用这种传统的开发方式，你难免会落入技术缠绕的纠结中，比如在想使用哪些类型的数据库表字段。也就是说，你在丢失关注点。  </p>
<p>而通过测试驱动，则会先引导你做正确的事，再将你的关注引导到领域业务上，最后将自然而然地就知道应用使用什么技术了。</p>
<h2>2.16.3 表达规则</h2>
<p>//TODO: 释意接口、业务规则的描述</p>
<h2>2.16.4 越痛苦的事情，越早做</h2>
<p>在有一次敏捷开发分享会上，有位前辈说：要对小问题不断进行优化迭代，而不要等到大问题来了再作变革。  </p>
<p>同样，在持续集成中，也提倡着类似的理念，即：越痛苦的事情，越早做。</p>
<hr />
<h4><a href="#">上一章</a>   <a href="/wikis/">文档首页</a>   <a href="#">下一章</a></h4>
            </div>
        </div>
    </div>
    
 
<!-- footer(S) -->
<div class="grid-wrapper footer">
	<div id="footer" class="grid">	

		<div class="grid__cell unit-1-2--lap">
			<h3><img src="http://webtools.qiniudn.com/master-LOGO-20150410_50.jpg" height="50"></h3>
            <p>
            <font size="3px;">PhalApi是一个PHP轻量级后台接口开发框架。<br/>
                我们致力于将PhalApi维护成像恒星一样：不断更新，保持生气；为接口负责，为开源负责！让后台接口开发更简单！
            </font>
			</p>
			<p align="left"><font size="2px">&copy;PhalApi All Rights Reserved. 粤ICP备15028808号</font></p>
		</div>	

		<div class="grid__cell unit-1-2--lap">
			<h3>在这里，特别感谢</h3>

			<div class="nav">
				<ul class="footer__nav">
					<li class="menu-item"><a href="http://www.oschina.net/" class="menu-item__link" target="_blank">开源中国</a></li>
					<li class="menu-item"><a href="http://www.phalconphp.com/en/" class="menu-item__link" target="_blank">Phalcon</a></li>
					<li class="menu-item"><a href="https://phpunit.de/manual/3.7/zh_cn/automating-tests.html" class="menu-item__link" target="_blank">PHPUnit</a></li>
					<li class="menu-item"><a href="http://www.thoughtworks.com/cn/" class="menu-item__link" target="_blank">ThoughtWorks</a></li>
				</ul>
			</div>

            <div id="perspectives">
                <div class="email-signup">
                    <strong><a href="https://auth.alipay.com/login/index.htm" target="_blank">支付宝&nbsp;</a>开源捐赠：</strong>chanzonghuang@gmail.com
                </div>
            </div>
		</div>
	</div>
</div>
<!-- footer(E) -->

</body>

<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1254743218'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "w.cnzz.com/q_stat.php%3Fid%3D1254743218' type='text/javascript'%3E%3C/script%3E"));</script>

</html>