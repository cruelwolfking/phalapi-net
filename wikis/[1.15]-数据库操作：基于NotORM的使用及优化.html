<!DOCTYPE html>
<html lang="cn" style="">
<head>
	<title>[1.15]-数据库操作：基于NotORM的使用及优化 | PhalApi - PHP轻量级后台接口开发框架</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="icon" href="http://webtools.qiniudn.com/dog_catch.png" type="image/x-icon" />
	<meta name="description" content="PhalApi是一个PHP轻量级后台接口开发框架。我们致力于将PhalApi维护成像恒星一样：不断更新，保持生气；为接口负责，为开源负责！让后台接口开发更简单！">
	<meta name="keywords" content="PhalApi,phalapi,phalapi接口开发,后台接口开发框架,后台接口开发,接口开发,接口框架,PHP后台接口开发,PHP接口开发,PHP接口框架,PHP后台接口框架,phalapi官网,PHP接口框架,phalapi文档,phalapi wiki,PhalApi文档,phalapi在线文档,phalapi官方文档">
	<meta name="author" content="dogstar">

	<link rel="stylesheet" type="text/css" href="./../css/screen.css?20150211" />
</head>

<body>

<!-- 最顶部的语言(S) -->
<div class="grid-wrapper navbar desktop-only">
	<div class="grid">
		<div class="grid__cell">
			<ul id="language-switchers" class="navbar__links navbar--left">
				<li class="menu-item"><a title="PhalApi官方网站中文版" href="./" class="menu-item__link">中文版</a></li>
				<li class="menu-item"><a title="English version of PhalApi website" href="#" class="menu-item__link">English</a></li>
			</ul>
			<ul id="util-menu" class="navbar__links navbar--right navbar--vertical-separator">
				<li class="menu-item"><a href="mailto:fuemoshi@gmail.com" class="menu-item__link contact-us-spec">保护大象，拒绝象牙！</a></li>
			</ul>
		</div>
	</div>
</div>
<!-- 最顶部的语言(E) -->

<!-- 顶部导航菜单(S) -->
<div class="grid-wrapper desktop-only">
	<div class="grid">
		<div class="grid__cell">
			<div class="header__header-wrapper">
				<a title="PhalApi" href="http://www.phalapi.net" class="header__logo"><img src="http://webtools.qiniudn.com/master-LOGO-20150410_33.jpg" id="tw-logo" alt="PhalApi"></a>
				<ul id="main-menu" class="header__menu">
					<li class="menu-item"><a href="http://git.oschina.net/dogstar/PhalApi/tree/release" class="menu-item__link insights-spec" target="_blank">下载</a></li>
					<li class="menu-item"><a href="/wikis/" class="menu-item__link events-spec" target="_blank">文档</a></li>
    				<li class="menu-item"><a href="/docs/" class="menu-item__link events-spec" target="_blank">类参考手册</a></li>
					<li class="menu-item"><a href="http://phalapi.oschina.mopaas.com/Public/demo/" class="menu-item__link products-spec" target="_blank">在线体验</a></li>
					<li class="menu-item"><a href="/about.html" class="menu-item__link about-us-spec" target="_blank">关于我们</a></li>
				</ul>
			</div>
		</div>
	</div>
</div>
<!-- 顶部导航菜单(E) -->

    <div class="grid-wrapper">
        <div class="grid">
            <div class="grid__cell">
                <h4><a href="/wikis/%5B1.14%5D-%E7%BB%9F%E4%B8%80%E7%9A%84%E8%BF%94%E5%9B%9E%E6%A0%BC%E5%BC%8F%E5%92%8C%E7%BB%93%E6%9E%84%EF%BC%9Aret-data-msg.html">上一章</a>   <a href="/wikis/">文档首页</a>   <a href="/wikis/%5B1.16%5D-%E9%85%8D%E7%BD%AE%E8%AF%BB%E5%8F%96%EF%BC%9A%E5%86%85%E5%A4%96%E7%BD%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E7%9A%84%E5%AE%8C%E7%BE%8E%E5%88%87%E6%8D%A2.html">下一章</a></h4>
<hr />
<h2>1.15.1 NotORM官网</h2>
<p>这里使用了NotORM进行DB操作，具体的数据库操作使用文档请见NotORM官网：<a href="http://www.notorm.com">http://www.notorm.com</a>  </p>
<h2>1.15.2 NotORM的优化</h2>
<p>但为了更符合项目的开发，这里对NotORM的底层作了升级修改，以下为主要修改点和新的使用：  </p>
<h3>(1)将原来返回的结果全部从对象改成数组</h3>
<p>对原来的大部分使用无特别影响，可按原来的方式开发。主要目的是为了更方面处理返回的数据，以及简化对结果的再解析，简单明了。<br />
如：</p>
<pre><code>DI()-&gt;notorm-&gt;user-&gt;where('username = ?', 'dogstar')-&gt;fetch();</code></pre>
<p>返回的将是一个数组：</p>
<pre><code>array(7) {
  ["id"]=&gt;
  string(3) "180"
  ["username"]=&gt;
  string(17) "dogstar"
  ["regtime"]=&gt;
  string(10) "1414811954"
  //...
}</code></pre>
<h3>(2)提供获取全部结果的接口 - fetchAll()</h3>
<p>如：  </p>
<pre><code>$rows = DI()-&gt;notorm-&gt;event_picurl-&gt;where('(eid)', $eids)-&gt;fetchAll();</code></pre>
<p>即可获取全部的数据，不再受限于分页。   </p>
<h3>(3)提供更灵活的查询方式 -queryRows()</h3>
<p>当需要进行复杂的SQL查询时，可以使用此接口，如：  </p>
<pre><code>$sql = 'select * from example AS ep LEFT JOIN user AS u ON ep.ui
d = u.id  where ep.touid = :userId ORDER BY dateline desc LIMIT :start,:num';
$params = array('userId' =&gt; $userId, ':start' =&gt; $start, ':num' =&gt; $num);
$rs= DI()-&gt;notorm-&gt;example-&gt;queryRows($sql, $params);</code></pre>
<h3>(4)修正原来的BUG</h3>
<p>进行LIMIT时 因加入了 OFFSET 关键字导致MySQL下无法获取数据  </p>
<h3>(5)禁止全表删除，防止误删</h3>
<h3>(6)开启HTTP调试模式</h3>
<p>当处于debug模式时，可以输入执行的全部SQL语句，以便调试。   </p>
<p>如：  </p>
<pre><code>SELECT times FROM tpl_user_session_10 WHERE (user_id = ?); -- '74110'
{"ret":0,"data":{"code":0},"msg":""}</code></pre>
<h2>1.15.3 可选的Model基类</h2>
<h3>(1)表数据入口模式</h3>
<p>我们一直在考虑，是否应该提供数据库的基本操作支持，以减少开发人员重复手工编写基本的数据操作。  </p>
<p>最后，我们认为是需要的。然后就引发了新的问题：是以继承还是以委托来支持？  </p>
<p>委托有助于降低继承的层级，但仍然需要编写同类的操作然后再次委托。所以，这里提供了基于NotORM的Model基类：PhalApi_Model_NotORM。  </p>
<p>然而提供这个基类还是会遇到一些问题，例如：如何界定基本操作？如何处理分表存储？如何支持定制化？  </p>
<p>由于我们这里的Model使用了 <strong>“表数据入口”</strong> 模式，而不是“行数据入口”，也不是“活动纪录”，也不是复杂的“数据映射器”。所以在使用时可以考虑是否需要此基类。即使这样，你也可以很轻松转换到“行数据入口”和“活动纪录”模式。这里，PhalApi中的Model是更广义上的数据源层（后面会有更多说明），因此对应地PhalApi_Model_NotORM基类充当了数据库表访问入口的对象，处理表中所有的行。  </p>
<h3>(2)规约层的CURD</h3>
<p>在明白了Model基类的背景后，再来了解其具体的操作和如何继承会更有意义。  </p>
<p>而具体的操作则与数据表的结构相关，在“约定编程”下：即每一个表都有一个主键（通常为id，也可以自由配置）以及一个序列化LOB字段ext_data。我们很容易想到Model接口的定义（注释已移除，感兴趣的同学可查看源码）：</p>
<pre><code>interface PhalApi_Model {

    public function get($id, $fields = '*');

    public function insert($data, $id = NULL);

    public function update($id, $data);

    public function delete($id);
}
</code></pre>
<p>上面的接口在规约层上提供了基于表主键的CURD基本操作，在具体实现时，需要注意两点：一是分表的处理；另一点则是LOB字段的序列化。  </p>
<h3>(3)不使用Model基类的写法</h3>
<p>由于我们使用了NotORM进行数据库的操作，所以这里也提供了基于NotORM的基类：PhalApi_Model_NotORM。下面以我们熟悉的获取用户的基本信息为例，说明此基类的使用。</p>
<p>为唤醒记忆，下面贴上Model_User类原来的代码：</p>
<pre><code>// $ vim ./Demo/Model/User.php

&lt;?php

class Model_User {

    public function getByUserId($userId) {
        return DI()-&gt;notorm-&gt;user-&gt;select('*')-&gt;where('id = ?', $userId)-&gt;fetch();
    }
}</code></pre>
<p>对应的调用：</p>
<pre><code>$model = new Model_User();
$rs = $model-&gt;getByUserId($userId);</code></pre>
<h3>(4)继承Model基类的写法</h3>
<p>若继承于PhalApi_Model_NotORM，则是：</p>
<pre><code>// $ vim ./Demo/Model/User.php

&lt;?php

class Model_User extends PhalApi_Model_NotORM {

    protected function getTableName($id) {
        return 'user';
    }
}</code></pre>
<p>从上面的代码可以看出，基类已经提供了基于主键的CURD操作，但我们需要钩子函数以返回对应的表名。相应地，外部调用则调整为：</p>
<pre><code>$model = new Model_User();
$rs = $model-&gt;get($userId);</code></pre>
<p>再进一步，我们可以得到其他的基本操作：</p>
<pre><code>$model = new Model_User();

// 插入
$model-&gt;insert(array('name' =&gt; 'whatever', 'from' =&gt; 'somewhere'));

// 更新
$model-&gt;update(1, array('name' =&gt; 'dogstar huang'));

// 删除
$model-&gt;delete(1);</code></pre>
<h2>1.15.4 定制化你的Model基类</h2>
<p>正如上面提及到的两个问题：LOB序列化和分表处理。所以，如果PhalApi现有就此两问题的解决方案不能满足项目的需求，可作定制化处理。  </p>
<h3>(1)LOB序列化</h3>
<p>先是LOB序列化，考虑到有分表的存在，当发生数据库变更时（特别在线上环境）会有一定的难度和风险，因此引入了扩展字段ext_data。当然，此字段也应对数据库变更的同时，也可以作为简单明了的值对象的大对象。序列化LOB首先要考虑的问题是使用二进制（BLOB）还是文本（CLOB），出于通用性、易读性和测试性，我们目前使用了json格式的文本序列化。所以，如果考虑到空间或性能问题（在少量数据下我认为问题不大，如果数据量大，应该及时重新调整数据库表结构），可以重写formatExtData() &amp; parseExtData()。  </p>
<p>如改成serialize序列化：</p>
<pre><code>abstract class My_Model_NotORM extends PhalApi_Model_NotORM {

    /**
     * 对LOB的ext_data字段进行格式化(序列化)
     */
    protected function formatExtData(&amp;$data) {
        if (isset($data['ext_data']) &amp;&amp; !is_string($data['ext_data'])) {
            $data['ext_data'] = serialize($data['ext_data']);
        }
    }

    /**
     * 对LOB的ext_data字段进行解析(反序列化)
     */
    protected function parseExtData(&amp;$data) {
        if (isset($data['ext_data']) &amp;&amp; !is_string($data['ext_data'])) {
            $data['ext_data'] = unserialize($data['ext_data'], true);
        }
    }

    // ...
}</code></pre>
<h3>(2)分表处理</h3>
<p>其次是分表处理，同样考虑到分表的情况，以及不同的表可能配置不同的主键表，而基于主键的CURD又必须要先知道表的主键名才能进行SQL查询。所以，问题就演变成了如何找到表的主键名。这里可以自动匹配，也可以手工指定。自动匹配是智能的，因为当我们更改表的主键时，可以自动同步更新而不需要担心遗漏（虽然这种情况很少发生）。手工指定可以大大减少系统不必要的匹配操作，因为我们开发人员也知道数据库的主键名是什么，但需要手工编写一些代码。在这里，提供了可选的手工指定，即可重写getTableKey($table)来指定你的主键名。</p>
<p>如，当我们的表的主键都固定为id时：</p>
<pre><code>abstract class My_Model_NotORM extends PhalApi_Model_NotORM {

    protected function getTableKey($table) {
        return 'id';
    }
}</code></pre>
<hr />
<h4><a href="/wikis/%5B1.14%5D-%E7%BB%9F%E4%B8%80%E7%9A%84%E8%BF%94%E5%9B%9E%E6%A0%BC%E5%BC%8F%E5%92%8C%E7%BB%93%E6%9E%84%EF%BC%9Aret-data-msg.html">上一章</a>   <a href="/wikis/">文档首页</a>   <a href="/wikis/%5B1.16%5D-%E9%85%8D%E7%BD%AE%E8%AF%BB%E5%8F%96%EF%BC%9A%E5%86%85%E5%A4%96%E7%BD%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E7%9A%84%E5%AE%8C%E7%BE%8E%E5%88%87%E6%8D%A2.html">下一章</a></h4>
            </div>
        </div>
    </div>
    
 
<!-- footer(S) -->
<div class="grid-wrapper footer">
	<div id="footer" class="grid">	

		<div class="grid__cell unit-1-2--lap">
			<h3><img src="http://webtools.qiniudn.com/master-LOGO-20150410_50.jpg" height="50"></h3>
            <p>
            <font size="3px;">PhalApi是一个PHP轻量级后台接口开发框架。<br/>
                我们致力于将PhalApi维护成像恒星一样：不断更新，保持生气；为接口负责，为开源负责！让后台接口开发更简单！
            </font>
			</p>
			<p align="left">&copy; PhalApi 开发团队 All Rights Reserved.</p>
		</div>	

		<div class="grid__cell unit-1-2--lap">
			<h3>在这里，特别感谢</h3>

			<div class="nav">
				<ul class="footer__nav">
					<li class="menu-item"><a href="http://www.oschina.net/" class="menu-item__link" target="_blank">开源中国</a></li>
					<li class="menu-item"><a href="http://www.phalconphp.com/en/" class="menu-item__link" target="_blank">Phalcon</a></li>
					<li class="menu-item"><a href="https://phpunit.de/manual/3.7/zh_cn/automating-tests.html" class="menu-item__link" target="_blank">PHPUnit</a></li>
					<li class="menu-item"><a href="http://www.thoughtworks.com/cn/" class="menu-item__link" target="_blank">ThoughtWorks</a></li>
				</ul>
			</div>

            <div id="perspectives">
                <div class="email-signup">
                    <strong><a href="https://auth.alipay.com/login/index.htm" target="_blank">支付宝&nbsp;</a>捐赠：</strong>chanzonghuang@gmail.com
                </div>
            </div>
		</div>
	</div>
</div>
<!-- footer(E) -->

</body>

<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1254743218'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "w.cnzz.com/q_stat.php%3Fid%3D1254743218' type='text/javascript'%3E%3C/script%3E"));</script>

</html>